<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://zatoima.github.io/favicon.svg" />
<title>ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した | my opinion is my own</title>
<meta name="title" content="ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した" />
<meta name="description" content="" />
<meta name="keywords" content="MCP,Claude,LLM,Snowflake," />


<meta property="og:url" content="https://zatoima.github.io/mcp-server-context-usage-optimization/">
  <meta property="og:site_name" content="my opinion is my own">
  <meta property="og:title" content="ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した">
  <meta property="og:description" content="memo blog。GitHub Pagesとして構成されています。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2026-02-25T00:00:00+00:00">
    <meta property="article:modified_time" content="2026-02-25T00:00:00+00:00">
    <meta property="article:tag" content="MCP">
    <meta property="article:tag" content="Claude">
    <meta property="article:tag" content="LLM">
    <meta property="article:tag" content="Snowflake">
    <meta property="og:image" content="https://zatoima.github.io/images/share.png">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://zatoima.github.io/images/share.png">
  <meta name="twitter:title" content="ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した">
  <meta name="twitter:description" content="memo blog。GitHub Pagesとして構成されています。">




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "\"ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した\"",
  "description": "\"\"",
  "datePublished": "\"2026-02-25T00:00:00Z\"",
  "dateModified": "\"2026-02-25T00:00:00Z\"",
  "author": {
    "@type": "Person",
    "name": "\"zatoima\"",
    "url": "https://zatoima.github.io/about/"
  },
  "publisher": {
    "@type": "Person",
    "name": "\"zatoima\""
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "\"https://zatoima.github.io/mcp-server-context-usage-optimization/\""
  },
  "wordCount":  5337 ,
  "keywords": "[\"MCP\",\"Claude\",\"LLM\",\"Snowflake\"]"
}
</script>

<meta name="referrer" content="no-referrer-when-downgrade" />

  <link rel="alternate" type="text/plain" href="/llms.txt" title="LLMs.txt" />
  <link rel="alternate" type="text/plain" href="/llms-full.txt" title="LLMs-full.txt" />

  <script>
    (function(){
      var t = localStorage.getItem('theme');
      if (t === 'dark' || ((!t || t === 'system') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script><link rel="stylesheet" href="/css/zenn.css">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-STFZ9QMXGM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-STFZ9QMXGM');
</script>
</head>

<body>
  <a href="#main" class="skip-link">メインコンテンツへスキップ</a>
  <div class="reading-progress"></div>
  <div class="site-wrapper">
    <header class="site-header">
      <div class="header-inner">
        <a href="/" class="site-logo">my opinion is my own</a>
        <nav class="header-nav">
<a href="/about/">About</a>
<a href="/blog/">Blog</a>
<a href="/index.xml">RSS</a>
<a href="/other/">Other</a>
<a href="/llms.txt" title="LLMs.txt - AI/LLM向けサイト情報">llms.txt</a>
</nav>
        <div class="header-actions">
          <button id="search-btn" class="header-icon-btn" aria-label="検索">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          </button>
          <button id="dark-mode-btn" class="header-icon-btn" aria-label="ダークモード切替">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          </button>
          <button id="hamburger-btn" class="hamburger-btn" aria-label="メニュー">
            <span></span><span></span><span></span>
          </button>
        </div>
      </div>
    </header>

    
    <div id="search-overlay" class="search-overlay">
      <div class="search-modal">
        <input type="text" id="search-input" class="search-input" placeholder="記事を検索... (Ctrl+K)" autocomplete="off">
        <div id="search-results" class="search-results"></div>
      </div>
    </div>

    
    <div id="nav-overlay" class="nav-overlay"></div>

    <main id="main" class="site-main">
<div class="article-layout">
  <article class="article-main">
    
    <nav class="breadcrumb" aria-label="パンくずリスト">
  <a href="/">ホーム</a>
  <span class="breadcrumb-sep">&gt;</span>
  
  <a href="/blog/">Blog</a>
  <span class="breadcrumb-sep">&gt;</span>
  
  <span class="breadcrumb-current">ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した</span>
</nav>

    
    <div class="article-card">
      <div class="article-header">
        <div class="article-emoji"><img src="/images/tags/mcp.svg" alt="MCP" class="tag-icon" loading="lazy"></div>
        <h1>ドキュメント系MCPサーバーのコンテキスト使用量を検証し改善した</h1>
        
        <div class="article-meta">
          <time class="article-date" datetime='2026-02-25'>
            2026/02/25 に公開
          </time>
          
          
          
          <span class="reading-time">📖 約10分</span>
        </div>
        <div class="article-tags">
          
          <a href="https://zatoima.github.io/blog/mcp/" class="tag-badge"><img src="/images/tags/mcp.svg" alt="MCP" class="tag-badge-icon" loading="lazy">MCP</a>
          
          <a href="https://zatoima.github.io/blog/claude/" class="tag-badge"><img src="/images/tags/claude.svg" alt="Claude" class="tag-badge-icon" loading="lazy">Claude</a>
          
          <a href="https://zatoima.github.io/blog/llm/" class="tag-badge"><img src="/images/tags/llm.svg" alt="LLM" class="tag-badge-icon" loading="lazy">LLM</a>
          
          <a href="https://zatoima.github.io/blog/snowflake/" class="tag-badge"><img src="/images/tags/snowflake.svg" alt="Snowflake" class="tag-badge-icon" loading="lazy">Snowflake</a>
          
        </div>
        
      </div>
      <div class="article-content">
        <h2 id="はじめに">はじめに</h2>
<p>MCPサーバーはLLMエージェントに外部ツールを提供する仕組みだが、ツールのレスポンスはすべてLLMのコンテキストウィンドウに入る。つまりMCPツールが返すデータ量がそのままコンテキスト消費に直結する。</p>
<p>本記事では、自作のSnowflake Docs MCPサーバーのコンテキスト使用量を実測し、問題点を特定した上で改善を行った過程と結果をまとめる。</p>
<div class="link-card">
    <a href="https://github.com/zatoima/snowflake-docs-mcp-server" target="_blank" rel="noopener noreferrer">
      <div class="link-card-body">
        <div class="link-card-text">
          <div class="link-card-title">GitHub - zatoima/snowflake-docs-mcp-server: MCP server for searching and retrieving Snowflake official documentation</div><div class="link-card-description">MCP server for searching and retrieving Snowflake official documentation - zatoima/snowflake-docs-mcp-server</div><div class="link-card-meta">
            <img class="link-card-favicon" src="https://www.google.com/s2/favicons?sz=32&amp;domain=github.com" alt="" loading="lazy" width="16" height="16">
            <span class="link-card-domain">github.com</span>
          </div>
        </div><div class="link-card-image">
            <img src="https://opengraph.githubassets.com/58ea2e91475f7d892b636a3bd79d8a5042ddd5faadedc8135ccb03b87a641a34/zatoima/snowflake-docs-mcp-server" alt="" loading="lazy">
          </div></div>
    </a>
  </div>
<h2 id="mcpツールのレスポンスとコンテキストの関係">MCPツールのレスポンスとコンテキストの関係</h2>
<p>MCPツールの呼び出し結果は、LLMへの入力としてコンテキストウィンドウに載る。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>[ユーザーメッセージ] + [システムプロンプト] + [MCPツール結果] + [過去の会話] = コンテキスト消費
</span></span></code></pre></div><p>ドキュメント取得系のMCPツールは、1回の呼び出しで数千〜数万文字を返すことがある。これを意識せずに設計すると、数回の呼び出しでコンテキストの大部分を消費し、会話の継続が困難になる。</p>
<h3 id="サブエージェント経由の場合">サブエージェント経由の場合</h3>
<p>Claude Codeのサブエージェント（Task tool）経由でMCPツールを使う場合、ツールの生レスポンスはサブエージェントのコンテキスト内に留まり、メインには要約のみが返る。これによりメインコンテキストの消費を大幅に削減できる。</p>
<table>
  <thead>
      <tr>
          <th>方式</th>
          <th>メインコンテキスト消費</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>直接呼び出し</td>
          <td>ツール結果の全文</td>
      </tr>
      <tr>
          <td>サブエージェント経由</td>
          <td>要約のみ（50-90%削減）</td>
      </tr>
  </tbody>
</table>
<p>ただしサブエージェントは合計トークン消費量が増え、レイテンシも大きくなるため、すべてをサブエージェント経由にするのは現実的ではない。MCPサーバー側でレスポンスサイズを適切に制御することが重要である。</p>
<h2 id="改善前の状態">改善前の状態</h2>
<p>改善前のサーバーは2つのツールを提供していた。</p>
<table>
  <thead>
      <tr>
          <th>ツール</th>
          <th>機能</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>search_snowflake_docs</code></td>
          <td>キーワード検索（excerpt 200文字、最大20件）</td>
      </tr>
      <tr>
          <td><code>get_doc_content</code></td>
          <td>ページ全文取得（HTML→Markdown変換）</td>
      </tr>
  </tbody>
</table>
<h3 id="実測結果">実測結果</h3>
<p>CREATE TABLE ページ（Snowflakeで最も大きいページの一つ）を対象に計測した。</p>
<p><strong>search_snowflake_docs:</strong></p>
<table>
  <thead>
      <tr>
          <th>max_results</th>
          <th>レスポンス文字数</th>
          <th>推定トークン数</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>3件</td>
          <td>~850</td>
          <td>~250</td>
      </tr>
      <tr>
          <td>5件（デフォルト）</td>
          <td>~1,400</td>
          <td>~400</td>
      </tr>
      <tr>
          <td>10件</td>
          <td>~2,800</td>
          <td>~800</td>
      </tr>
      <tr>
          <td>20件（最大）</td>
          <td>~5,500</td>
          <td>~1,500</td>
      </tr>
  </tbody>
</table>
<p>検索ツールは軽量で問題なし。</p>
<p><strong>get_doc_content:</strong></p>
<table>
  <thead>
      <tr>
          <th>max_length</th>
          <th>レスポンス文字数</th>
          <th>推定トークン数</th>
          <th>備考</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>2,000</td>
          <td>~2,200</td>
          <td>~600</td>
          <td></td>
      </tr>
      <tr>
          <td>4,000</td>
          <td>~4,200</td>
          <td>~1,100</td>
          <td></td>
      </tr>
      <tr>
          <td>8,000（デフォルト）</td>
          <td>~8,200</td>
          <td>~2,200</td>
          <td></td>
      </tr>
      <tr>
          <td>0（無制限）</td>
          <td><strong>102,079</strong></td>
          <td><strong>~25,000+</strong></td>
          <td>コンテキスト上限超過</td>
      </tr>
  </tbody>
</table>
<h3 id="発見された問題">発見された問題</h3>
<p><strong>1. テキスト重複バグ</strong></p>
<p>HTML→Markdown変換に <code>descendants</code> イテレータを使っていたため、<code>&lt;li&gt;</code> 内の <code>&lt;p&gt;</code> で同じテキストが2回出力されていた。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>- Requires a value (NOT NULL).
</span></span><span style="display:flex;"><span>Requires a value (NOT NULL).          ← 重複
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- Has a default value.
</span></span><span style="display:flex;"><span>Has a default value.                  ← 重複
</span></span></code></pre></div><p>リスト10項目が20行に膨張し、<strong>コンテンツの30-40%が無駄な重複</strong>に消費されていた。</p>
<p><strong>2. max_length=0 でコンテキスト破綻</strong></p>
<p>CREATE TABLEページを無制限取得すると102,079文字が返り、Claude Codeのトークン上限を超えてファイルに退避された。ファイル退避されるとコンテキスト内で直接参照できなくなり、実質的に使い物にならない。</p>
<p><strong>3. セクション指定取得ができない</strong></p>
<p>ページの先頭から <code>max_length</code> 分だけ切り取る方式のため、Usage NotesやExamplesなどページ後半にある重要情報に到達できなかった。</p>
<p><strong>4. ページ構造の確認手段がない</strong></p>
<p>どんなセクションがあるかを知るためにも <code>get_doc_content</code> で全文取得する必要があった。</p>
<p><strong>5. Markdown出力のノイズ</strong></p>
<p>HTML→Markdown変換後に、LLMにとって不要なアーティファクトが多数残留していた。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>## Usage notes[¶](#usage-notes &#34;Link to this heading&#34;)     ← pilcrowリンク（~40 chars/見出し）
</span></span><span style="display:flex;"><span>Copy                                                        ← コピーボタンの残骸
</span></span><span style="display:flex;"><span>[COPY INTO &lt;table&gt;](copy-into-table)                        ← 辿れない相対リンク
</span></span></code></pre></div><p>CREATE TABLEページ（24見出し）だけでpilcrowリンクに約960文字が消費されていた。</p>
<h2 id="改善の過程">改善の過程</h2>
<h3 id="aws公式mcpサーバーの調査">AWS公式MCPサーバーの調査</h3>
<p>改善の参考として、AWSが公式に提供しているドキュメントMCPサーバーの実装を調査した。参考になった設計ポイントは以下の通り。</p>
<ul>
<li><strong>markdownifyライブラリの使用</strong>: 手書きのHTMLパーサーではなく <code>markdownify</code> ライブラリでHTML→Markdown変換を行っており、重複バグのような問題は構造的に発生しない</li>
<li><strong>start_indexによるページネーション</strong>: 長文ドキュメントを <code>start_index</code> パラメータで分割読み込みする設計</li>
<li><strong>max_lengthの安全な制約</strong>: Pydantic Fieldで <code>gt=0, lt=1000000</code> の制約をかけ、0（無制限）を入力できないようにしている</li>
<li><strong>instructionsへのベストプラクティス記載</strong>: 「30,000文字超のドキュメントは、必要な情報が見つかった時点で読み込みを止めること」と明記</li>
</ul>
<h3 id="取り組み1-htmlmarkdown変換の品質改善">取り組み1: HTML→Markdown変換の品質改善</h3>
<p>手書きの <code>descendants</code> ループを <code>markdownify</code> ライブラリに置き換えた。これによりテキスト重複バグが解消され、同じ文字数でも実効的に約1.5倍の情報量を含むようになった。</p>
<p>さらに、Markdown変換後のノイズ除去を実装した。</p>
<ul>
<li>pilcrowリンク（<code>[¶](...)</code>）の除去</li>
<li>コピーボタンの残骸（<code>Copy</code>）の除去</li>
<li>リンクURLの除去（テキストのみ保持）</li>
<li>画像・SVGタグの除去</li>
<li>フィードバック・評価・アンケート・フォーム要素の除去</li>
</ul>
<p>ポイントは除去の段階を分けている点。ボタンや画像はHTML段階で <code>decompose()</code> し、pilcrowやCopyの残骸はMarkdown変換後にテキストレベルで除去する。<code>&lt;a&gt;</code> タグは <code>unwrap()</code> でタグだけ除去しテキストは保持する。</p>
<h3 id="取り組み2-段階的な情報取得の導入">取り組み2: 段階的な情報取得の導入</h3>
<p>2つだったツールを5つに増やし、段階的な情報取得を可能にした。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>search_snowflake_docs  → ドキュメント検索（include_headings=Trueで目次も同時取得可能）
</span></span><span style="display:flex;"><span>search_in_doc          → ページ内キーワード検索（関連セクション自動選択）
</span></span><span style="display:flex;"><span>get_doc_toc            → ページの目次取得（軽量）
</span></span><span style="display:flex;"><span>get_doc_section        → 特定セクションの取得
</span></span><span style="display:flex;"><span>get_doc_content        → ページ全文の取得（ページネーション対応）
</span></span></code></pre></div><p>推奨される使い方の流れ。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>1. search_snowflake_docs(include_headings=True) で検索+目次を1回で取得
</span></span><span style="display:flex;"><span>2. search_in_doc で関連セクションだけ自動抽出
</span></span><span style="display:flex;"><span>3. コード例が必要な場合のみ include_code_blocks=True を指定
</span></span></code></pre></div><h3 id="取り組み3-レスポンスサイズの制御">取り組み3: レスポンスサイズの制御</h3>
<p><code>max_length</code> のハードキャップを設け、コンテキスト破綻を防止した。</p>
<table>
  <thead>
      <tr>
          <th>max_length の値</th>
          <th>挙動</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>全文取得の意図を尊重し、ハードキャップ(20,000)まで返す</td>
      </tr>
      <tr>
          <td>1〜20,000</td>
          <td>指定値そのまま</td>
      </tr>
      <tr>
          <td>20,001以上</td>
          <td>20,000にキャップ</td>
      </tr>
      <tr>
          <td>負値</td>
          <td>デフォルト(5,000)にフォールバック</td>
      </tr>
  </tbody>
</table>
<p>加えて <code>start_index</code> パラメータによるページネーション、自然な位置での境界切断（段落→行→文→単語の優先度）を導入した。</p>
<h3 id="取り組み4-コードブロックのデフォルトoff">取り組み4: コードブロックのデフォルトOFF</h3>
<p>構文リファレンスページではコードブロックがコンテキストの大半を占める。CREATE TABLEページで計測した結果、コードブロックを除去すると <strong>37.7%のコンテキスト削減</strong> が得られた。</p>
<table>
  <thead>
      <tr>
          <th>モード</th>
          <th>サイズ</th>
          <th>削減率</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>コードブロックON</td>
          <td>52,694 chars</td>
          <td>-</td>
      </tr>
      <tr>
          <td>コードブロックOFF</td>
          <td>32,851 chars</td>
          <td>37.7%</td>
      </tr>
  </tbody>
</table>
<p><code>include_code_blocks</code> パラメータのデフォルト値を <code>False</code> に変更し、構文やコード例が必要な場合のみ明示的に指定する運用にした。</p>
<h3 id="取り組み5-ツール呼び出し回数の削減">取り組み5: ツール呼び出し回数の削減</h3>
<p><code>search_snowflake_docs</code> に <code>include_headings</code> パラメータを追加し、検索と同時にページの見出し構造を取得できるようにした。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>改善前: search → get_doc_toc → get_doc_section  (3回)
</span></span><span style="display:flex;"><span>改善後: search(include_headings=True) → get_doc_section  (2回)
</span></span></code></pre></div><p>ただし見出しの多いページ（120件以上の見出しを持つDB2移行ガイド等）でレスポンスが膨張する問題があったため、1結果あたり30見出し上限のキャップを設けた。超過時はh1-h3のみに絞り込む。</p>
<h3 id="取り組み6-ページ内キーワード検索">取り組み6: ページ内キーワード検索</h3>
<p><code>search_in_doc</code> ツールを追加した。URLとキーワードを渡すと、ページ内の全セクションをスコアリングし、関連度の高いセクションだけを返す。これにより目次確認→セクション選択の判断をMCPサーバー側で行えるようになった。</p>
<p>スコアリング精度の問題として、親セクションの <code>get_text()</code> が子セクションのテキストを全て含むため常に親のスコアが高くなる問題があった。子セクションのテキストを親スコアから除外し、ネスト重複排除を行うことで解決した。</p>
<h3 id="取り組み7-キャッシュとパフォーマンス改善">取り組み7: キャッシュとパフォーマンス改善</h3>
<ul>
<li>同一URLへの重複HTTPフェッチを排除するTTL付きインメモリキャッシュ（5分、LRU 50エントリ上限）</li>
<li>buildIdキャッシュ（1時間TTL）</li>
<li>共有HTTPクライアントによるコネクションプーリング</li>
<li><code>asyncio.gather</code> による並列headings取得</li>
</ul>
<h2 id="改善結果">改善結果</h2>
<h3 id="get_doc_content-全文取得の比較">get_doc_content 全文取得の比較</h3>
<p>CREATE TABLEページを <code>get_doc_content(include_code_blocks=False)</code> で全文取得した比較。</p>
<table>
  <thead>
      <tr>
          <th>条件</th>
          <th>改善前</th>
          <th>改善後</th>
          <th>備考</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>max_length=2000</td>
          <td>~2,200 chars（30-40%が重複）</td>
          <td>2,269 chars（重複なし）</td>
          <td>同文字数で情報量約1.5倍</td>
      </tr>
      <tr>
          <td>max_length=5000</td>
          <td>—</td>
          <td>5,351 chars</td>
          <td>改善後のデフォルト</td>
      </tr>
      <tr>
          <td>max_length=8000</td>
          <td>~8,200 chars（30-40%が重複）</td>
          <td>8,450 chars（重複なし）</td>
          <td>改善前のデフォルト</td>
      </tr>
      <tr>
          <td>max_length=0</td>
          <td><strong>102,079 chars（破綻）</strong></td>
          <td><strong>20,000以下（安全）</strong></td>
          <td>95%以上削減</td>
      </tr>
  </tbody>
</table>
<h3 id="複数ページでの全文取得比較">複数ページでの全文取得比較</h3>
<p>CREATE TABLE以外のページでも同様の効果があるかを検証した。</p>
<table>
  <thead>
      <tr>
          <th>ページ</th>
          <th>改善前</th>
          <th>改善後</th>
          <th>削減率</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>CREATE TABLE（大規模SQLリファレンス）</td>
          <td>70,948 chars</td>
          <td>44,503 chars</td>
          <td><strong>37.3%</strong></td>
      </tr>
      <tr>
          <td>SELECT（大規模SQLリファレンス）</td>
          <td>25,068 chars</td>
          <td>10,538 chars</td>
          <td><strong>58.0%</strong></td>
      </tr>
      <tr>
          <td>Dynamic Tables（中規模ガイド）</td>
          <td>5,409 chars</td>
          <td>4,529 chars</td>
          <td><strong>16.3%</strong></td>
      </tr>
      <tr>
          <td><strong>合計</strong></td>
          <td><strong>101,425 chars</strong></td>
          <td><strong>59,570 chars</strong></td>
          <td><strong>41.3%</strong></td>
      </tr>
  </tbody>
</table>
<p>リンクの多いリファレンスページほど効果が大きく、SELECTページでは58%の大幅な削減を達成した。小規模ガイドページでは削減率が比較的小さいが、元々のサイズが小さいため実用上の影響は少ない。</p>
<h3 id="典型的な使用パターンの比較">典型的な使用パターンの比較</h3>
<table>
  <thead>
      <tr>
          <th>パターン</th>
          <th>改善前</th>
          <th>改善後</th>
          <th>改善</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>search + get_doc_content</td>
          <td>~9,600 chars</td>
          <td>7,378 chars</td>
          <td>23%削減</td>
      </tr>
      <tr>
          <td>search + 2x get_doc_content</td>
          <td>~17,800 chars</td>
          <td>12,714 chars</td>
          <td>29%削減</td>
      </tr>
      <tr>
          <td>search + TOC + 1 section</td>
          <td>不可能</td>
          <td>9,408 chars</td>
          <td>新機能</td>
      </tr>
      <tr>
          <td>search(headings) + section(code=OFF)</td>
          <td>不可能</td>
          <td>3,115 chars</td>
          <td><strong>最適フロー</strong></td>
      </tr>
      <tr>
          <td>Usage Notes だけ欲しい</td>
          <td>不可能（到達できない）</td>
          <td>5,267 chars</td>
          <td>新機能</td>
      </tr>
  </tbody>
</table>
<p>最も効率的なフロー（<code>search(max_results=1, include_headings=True)</code> → <code>get_doc_section(code=OFF)</code>）で、改善前の典型フローと比べて約58%のコンテキスト削減を達成した。</p>
<h3 id="新ツールのコンテキスト消費">新ツールのコンテキスト消費</h3>
<table>
  <thead>
      <tr>
          <th>ツール</th>
          <th>消費量</th>
          <th>用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>search_snowflake_docs</code>（3件）</td>
          <td>~850 chars</td>
          <td>検索結果のみ</td>
      </tr>
      <tr>
          <td><code>get_doc_toc</code></td>
          <td>~600 chars</td>
          <td>ページ構造の確認</td>
      </tr>
      <tr>
          <td><code>get_doc_section</code>（1セクション）</td>
          <td>~528 chars</td>
          <td>特定セクションの取得</td>
      </tr>
      <tr>
          <td><code>search_in_doc</code>（3セクション）</td>
          <td>~2,400 chars</td>
          <td>関連セクション自動抽出</td>
      </tr>
      <tr>
          <td><code>get_doc_content</code>（全文、code=OFF）</td>
          <td>~44,503 chars</td>
          <td>ページ全体</td>
      </tr>
  </tbody>
</table>
<p><code>search_in_doc</code> で必要なセクションだけ取得すれば、<code>get_doc_content</code> 全文の約9分の1のコンテキストで済む。</p>
<h3 id="include_headings-の影響">include_headings の影響</h3>
<table>
  <thead>
      <tr>
          <th>パターン</th>
          <th>推定文字数</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>search（5件、headings=false）</td>
          <td>~500文字</td>
      </tr>
      <tr>
          <td>search（5件、headings=true）</td>
          <td>~3,500〜5,000文字</td>
      </tr>
  </tbody>
</table>
<p><code>include_headings=true</code> にすると約7〜10倍のコンテキストを消費するが、<code>get_doc_toc</code> の呼び出しを省略できる。見出しキャップ導入前は見出しの多いページで26,443文字以上に膨張していたが、導入後は10,853文字以内に収まるようになった（<strong>59%削減</strong>）。</p>
<h2 id="ドキュメント系mcpサーバー設計のポイント">ドキュメント系MCPサーバー設計のポイント</h2>
<p>今回の改善で得られた知見をまとめる。</p>
<ol>
<li><strong>レスポンスサイズにハードキャップを設ける</strong> — 無制限取得はコンテキスト破綻のリスクがある</li>
<li><strong>ページネーションを提供する</strong> — <code>start_index</code> + <code>max_length</code> で分割読み込みできるようにする</li>
<li><strong>段階的な情報取得を可能にする</strong> — 検索 → 目次確認（軽量） → セクション取得（必要な部分だけ）</li>
<li><strong>HTML→Markdown変換にはライブラリを使う</strong> — 手書きのHTMLパーサーはバグの温床になる</li>
<li><strong>instructionsにベストプラクティスを記載する</strong> — LLMがツールをどう使うべきかのガイドをサーバー側から提供する</li>
<li><strong>ツール呼び出し回数を削減する</strong> — 複数のツール呼び出しを1回にまとめるオプションを提供する</li>
<li><strong>コードブロックをデフォルトで除外する</strong> — 構文リファレンスではコードブロックがレスポンスの30〜40%を占める</li>
<li><strong>HTTP重複フェッチをキャッシュで排除する</strong> — 同一URLへの連続アクセスは頻発する</li>
<li><strong>Markdown出力のノイズを除去する</strong> — pilcrowリンク、コピーボタン、リンクURL、画像タグ等を除去する</li>
<li><strong>大量データを返すパラメータに安全弁を設ける</strong> — 見出しキャップのような上限を設ける</li>
</ol>
<h2 id="まとめ">まとめ</h2>
<p>自作のSnowflake Docs MCPサーバーのコンテキスト使用量を実測し、以下の改善を行った。</p>
<table>
  <thead>
      <tr>
          <th>改善</th>
          <th>効果</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>HTML→Markdown変換の品質改善</td>
          <td>テキスト重複解消、ノイズ除去で全文取得時 <strong>平均41.3%削減</strong></td>
      </tr>
      <tr>
          <td>段階的な情報取得の導入</td>
          <td>必要なセクションだけ取得で全文の <strong>約9分の1</strong></td>
      </tr>
      <tr>
          <td>コードブロックのデフォルトOFF</td>
          <td><strong>37.7%削減</strong></td>
      </tr>
      <tr>
          <td>ツール呼び出し回数の削減</td>
          <td>3ステップ → 2ステップ</td>
      </tr>
      <tr>
          <td>レスポンスサイズの制御</td>
          <td>102,079 chars → <strong>20,000以下</strong>（破綻防止）</td>
      </tr>
      <tr>
          <td>最適フロー全体</td>
          <td><strong>約58%のコンテキスト削減</strong></td>
      </tr>
  </tbody>
</table>
<p>MCPサーバーを設計する際は、レスポンスのサイズ = LLMのコンテキスト消費であることを意識し、「必要な情報だけを、必要な分だけ、ノイズなく返す」設計にすることが重要である。</p>
<h2 id="関連記事">関連記事</h2>
<div class="link-card">
    <a href="https://zatoima.github.io/snowflake-docs-mcp-server-architecture/" target="_blank" rel="noopener noreferrer">
      <div class="link-card-body">
        <div class="link-card-text">
          <div class="link-card-title">Snowflakeドキュメント検索MCPサーバーを作成した</div><div class="link-card-description">MCPサーバーの技術的な仕組み（Next.jsのbuildId取得、検索API、HTML→Markdown変換）</div><div class="link-card-meta">
            <img class="link-card-favicon" src="https://www.google.com/s2/favicons?sz=32&amp;domain=zatoima.github.io" alt="" loading="lazy" width="16" height="16">
            <span class="link-card-domain">zatoima.github.io</span>
          </div>
        </div></div>
    </a>
  </div>
<div class="link-card">
    <a href="https://zatoima.github.io/snowflake-mcp-documentation-server-benchmark/" target="_blank" rel="noopener noreferrer">
      <div class="link-card-body">
        <div class="link-card-text">
          <div class="link-card-title">Snowflake MCPドキュメントサーバー2種のベンチマーク比較</div><div class="link-card-description">本MCPサーバーとCortex Agent &#43; CKEベースのMCPサーバーを20クエリ・5評価軸で比較</div><div class="link-card-meta">
            <img class="link-card-favicon" src="https://www.google.com/s2/favicons?sz=32&amp;domain=zatoima.github.io" alt="" loading="lazy" width="16" height="16">
            <span class="link-card-domain">zatoima.github.io</span>
          </div>
        </div></div>
    </a>
  </div>
<h2 id="参考資料">参考資料</h2>
<div class="link-card">
    <a href="https://github.com/awslabs/mcp/tree/main/src/aws-documentation-mcp-server" target="_blank" rel="noopener noreferrer">
      <div class="link-card-body">
        <div class="link-card-text">
          <div class="link-card-title">mcp/src/aws-documentation-mcp-server at main · awslabs/mcp</div><div class="link-card-description">Official MCP Servers for AWS. Contribute to awslabs/mcp development by creating an account on GitHub.</div><div class="link-card-meta">
            <img class="link-card-favicon" src="https://www.google.com/s2/favicons?sz=32&amp;domain=github.com" alt="" loading="lazy" width="16" height="16">
            <span class="link-card-domain">github.com</span>
          </div>
        </div><div class="link-card-image">
            <img src="https://repository-images.githubusercontent.com/952238700/4fcd85d9-3950-4896-81cd-a03df4be9892" alt="" loading="lazy">
          </div></div>
    </a>
  </div>
<div class="link-card">
    <a href="https://github.com/zatoima/snowflake-docs-mcp-server" target="_blank" rel="noopener noreferrer">
      <div class="link-card-body">
        <div class="link-card-text">
          <div class="link-card-title">GitHub - zatoima/snowflake-docs-mcp-server: MCP server for searching and retrieving Snowflake official documentation</div><div class="link-card-description">MCP server for searching and retrieving Snowflake official documentation - zatoima/snowflake-docs-mcp-server</div><div class="link-card-meta">
            <img class="link-card-favicon" src="https://www.google.com/s2/favicons?sz=32&amp;domain=github.com" alt="" loading="lazy" width="16" height="16">
            <span class="link-card-domain">github.com</span>
          </div>
        </div><div class="link-card-image">
            <img src="https://opengraph.githubassets.com/58ea2e91475f7d892b636a3bd79d8a5042ddd5faadedc8135ccb03b87a641a34/zatoima/snowflake-docs-mcp-server" alt="" loading="lazy">
          </div></div>
    </a>
  </div>
<div class="link-card">
    <a href="https://pypi.org/project/markdownify/" target="_blank" rel="noopener noreferrer">
      <div class="link-card-body">
        <div class="link-card-text">
          <div class="link-card-title">&lt;meta property=&#34;og:title&#34;
markdownify</div><div class="link-card-description">Convert HTML to markdown.</div><div class="link-card-meta">
            <img class="link-card-favicon" src="https://www.google.com/s2/favicons?sz=32&amp;domain=pypi.org" alt="" loading="lazy" width="16" height="16">
            <span class="link-card-domain">pypi.org</span>
          </div>
        </div><div class="link-card-image">
            <img src="#ZgotmplZ" alt="" loading="lazy">
          </div></div>
    </a>
  </div>

      </div>
    </div>

    
    
    
    <a href="https://github.com/zatoima/zatoima.github.io/edit/main/content/blog/2026-02-25-mcp-server-context-usage-optimization/index.md" target="_blank" rel="noopener noreferrer" class="github-edit-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      GitHubで編集を提案
    </a>
    
    

    
    
    <nav class="prev-next-nav">
      
      <a href="https://zatoima.github.io/llm-papers-pipeline-with-claude-code/" class="prev-next-link prev-link">
        <span class="prev-next-label">← 前の記事</span>
        <span class="prev-next-title">Claude CodeでLLM論文の自動収集・要約・公開パイプラインを構築した</span>
      </a>
      
      
      <a href="https://zatoima.github.io/llm-papers-2026-02-25/" class="prev-next-link next-link">
        <span class="prev-next-label">次の記事 →</span>
        <span class="prev-next-title">LLM論文サーベイ（2026-02-25）</span>
      </a>
      
    </nav>
    

    
<div class="share-buttons">
  <span class="share-label">共有:</span>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fzatoima.github.io%2fmcp-server-context-usage-optimization%2f&text=%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E7%B3%BBMCP%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E4%BD%BF%E7%94%A8%E9%87%8F%E3%82%92%E6%A4%9C%E8%A8%BC%E3%81%97%E6%94%B9%E5%96%84%E3%81%97%E3%81%9F" target="_blank" rel="noopener noreferrer" class="share-btn share-twitter" aria-label="Xで共有">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
  </a>
  <a href="https://b.hatena.ne.jp/entry/https://zatoima.github.io/mcp-server-context-usage-optimization/" target="_blank" rel="noopener noreferrer" class="share-btn share-hatena" aria-label="はてなブックマークに追加">B!</a>
</div>



<div class="related-articles">
  <h2 class="related-articles-title">関連しているかもしれない記事</h2>
  <ul class="related-list">
    
    <li><a href="/llm-papers-pipeline-with-claude-code/">Claude CodeでLLM論文の自動収集・要約・公開パイプラインを構築した</a></li>
    
    <li><a href="/snowflake-docs-mcp-server-architecture/">Snowflakeドキュメント検索MCPサーバーを作成した</a></li>
    
    <li><a href="/llm-papers-2026-02-25/">LLM論文サーベイ（2026-02-25）</a></li>
    
    <li><a href="/llm-papers-2026-02-24/">LLM論文サーベイ（2026-02-24）</a></li>
    
    <li><a href="/llm-papers-2026-02-23/">LLM論文サーベイ（2026-02-23）</a></li>
    
  </ul>
</div>




<div class="post-tags">
  
  <a href="https://zatoima.github.io/blog/mcp/" class="tag-badge"><img src="/images/tags/mcp.svg" alt="MCP" class="tag-badge-icon" loading="lazy">MCP</a>
  
  <a href="https://zatoima.github.io/blog/claude/" class="tag-badge"><img src="/images/tags/claude.svg" alt="Claude" class="tag-badge-icon" loading="lazy">Claude</a>
  
  <a href="https://zatoima.github.io/blog/llm/" class="tag-badge"><img src="/images/tags/llm.svg" alt="LLM" class="tag-badge-icon" loading="lazy">LLM</a>
  
  <a href="https://zatoima.github.io/blog/snowflake/" class="tag-badge"><img src="/images/tags/snowflake.svg" alt="Snowflake" class="tag-badge-icon" loading="lazy">Snowflake</a>
  
</div>


  </article>

  
  <aside class="article-sidebar">
    <div class="toc-container">
      <div class="toc-title">目次</div>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#mcpツールのレスポンスとコンテキストの関係">MCPツールのレスポンスとコンテキストの関係</a>
      <ul>
        <li><a href="#サブエージェント経由の場合">サブエージェント経由の場合</a></li>
      </ul>
    </li>
    <li><a href="#改善前の状態">改善前の状態</a>
      <ul>
        <li><a href="#実測結果">実測結果</a></li>
        <li><a href="#発見された問題">発見された問題</a></li>
      </ul>
    </li>
    <li><a href="#改善の過程">改善の過程</a>
      <ul>
        <li><a href="#aws公式mcpサーバーの調査">AWS公式MCPサーバーの調査</a></li>
        <li><a href="#取り組み1-htmlmarkdown変換の品質改善">取り組み1: HTML→Markdown変換の品質改善</a></li>
        <li><a href="#取り組み2-段階的な情報取得の導入">取り組み2: 段階的な情報取得の導入</a></li>
        <li><a href="#取り組み3-レスポンスサイズの制御">取り組み3: レスポンスサイズの制御</a></li>
        <li><a href="#取り組み4-コードブロックのデフォルトoff">取り組み4: コードブロックのデフォルトOFF</a></li>
        <li><a href="#取り組み5-ツール呼び出し回数の削減">取り組み5: ツール呼び出し回数の削減</a></li>
        <li><a href="#取り組み6-ページ内キーワード検索">取り組み6: ページ内キーワード検索</a></li>
        <li><a href="#取り組み7-キャッシュとパフォーマンス改善">取り組み7: キャッシュとパフォーマンス改善</a></li>
      </ul>
    </li>
    <li><a href="#改善結果">改善結果</a>
      <ul>
        <li><a href="#get_doc_content-全文取得の比較">get_doc_content 全文取得の比較</a></li>
        <li><a href="#複数ページでの全文取得比較">複数ページでの全文取得比較</a></li>
        <li><a href="#典型的な使用パターンの比較">典型的な使用パターンの比較</a></li>
        <li><a href="#新ツールのコンテキスト消費">新ツールのコンテキスト消費</a></li>
        <li><a href="#include_headings-の影響">include_headings の影響</a></li>
      </ul>
    </li>
    <li><a href="#ドキュメント系mcpサーバー設計のポイント">ドキュメント系MCPサーバー設計のポイント</a></li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#関連記事">関連記事</a></li>
    <li><a href="#参考資料">参考資料</a></li>
  </ul>
</nav>
    </div>
  </aside>
  
</div>

    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-disclaimer">本ブログの内容は個人的な見解であり、所属する企業・組織の公式な見解を示すものではありません。</div>
        <div class="footer-links">
          <a href="/">ホーム</a>
          <a href="/blog/">記事一覧</a>
          <a href="/tags/">タグ一覧</a>
          <a href="/about/">About</a>
        </div>
        <div class="footer-social">
          <a href="https://github.com/zatoima" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          </a>
          <a href="https://x.com/zatoima1" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          </a>
          <a href="/index.xml" aria-label="RSS">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19.01 7.38 20 6.18 20C5 20 4 19.01 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg>
          </a>
        </div>
        <div class="footer-copyright">Copyright © 2019, zatoima.</div>
        <div class="footer-disclaimer">GitHub Pagesとして構成されています。</div>
        <div class="footer-disclaimer">本ブログの内容は個人的な見解であり、所属する企業・組織の公式な見解を示すものではありません。</div>
      </div>
    </footer>
  </div>
  <script src="/js/lightbox.js" defer></script>
  <script src="/js/toc-highlight.js" defer></script>
  <script src="/js/code-copy.js" defer></script>
  <script src="/js/dark-mode.js" defer></script>
  <script src="/js/mobile-nav.js" defer></script>
  <script src="/js/search.js" defer></script>
  <script src="/js/reading-progress.js" defer></script>
</body>

</html>
