<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://zatoima.github.io/favicon.ico" />
<title>S3オブジェクトの整合性チェックをどのように行うのか | my opinion is my own</title>
<meta name="title" content="S3オブジェクトの整合性チェックをどのように行うのか" />
<meta name="description" content="" />
<meta name="keywords" content="AWS,S3," />


<meta property="og:title" content="S3オブジェクトの整合性チェックをどのように行うのか" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zatoima.github.io/aws-s3-object-checksum-how-to/" /><meta property="og:image" content="https://zatoima.github.io/images/share.png"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-01-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-11T00:00:00+00:00" /><meta property="og:site_name" content="my opinion is my own" />




<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zatoima.github.io/images/share.png"/>

<meta name="twitter:title" content="S3オブジェクトの整合性チェックをどのように行うのか"/>
<meta name="twitter:description" content=""/>



<meta itemprop="name" content="S3オブジェクトの整合性チェックをどのように行うのか">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2022-01-11T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-01-11T00:00:00+00:00" />
<meta itemprop="wordCount" content="322"><meta itemprop="image" content="https://zatoima.github.io/images/share.png"/>
<meta itemprop="keywords" content="AWS,S3," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  <script>
    (function(){
      var t = localStorage.getItem('theme');
      if (t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script><link rel="stylesheet" href="/css/zenn.css">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-STFZ9QMXGM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-STFZ9QMXGM');
</script>
</head>

<body>
  <div class="site-wrapper">
    <header class="site-header">
      <div class="header-inner">
        <a href="/" class="site-logo">my opinion is my own</a>
        <nav class="header-nav">
<a href="/about/">About</a>
<a href="/blog/">Blog</a>
<a href="/index.xml">RSS</a>
<a href="/other/">Other</a>
</nav>
        <div class="header-actions">
          <button id="search-btn" class="header-icon-btn" aria-label="検索">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          </button>
          <button id="dark-mode-btn" class="header-icon-btn" aria-label="ダークモード切替">🌙</button>
          <button id="hamburger-btn" class="hamburger-btn" aria-label="メニュー">
            <span></span><span></span><span></span>
          </button>
        </div>
      </div>
    </header>

    
    <div id="search-overlay" class="search-overlay">
      <div class="search-modal">
        <input type="text" id="search-input" class="search-input" placeholder="記事を検索... (Ctrl+K)" autocomplete="off">
        <div id="search-results" class="search-results"></div>
      </div>
    </div>

    
    <div id="nav-overlay" class="nav-overlay"></div>

    <main class="site-main">
<div class="article-layout">
  <article class="article-main">
    
    <nav class="breadcrumb" aria-label="パンくずリスト">
  <a href="/">ホーム</a>
  <span class="breadcrumb-sep">&gt;</span>
  
  <a href="/blog/">Blog</a>
  <span class="breadcrumb-sep">&gt;</span>
  
  <span class="breadcrumb-current">S3オブジェクトの整合性チェックをどのように行うのか</span>
</nav>

    
    <div class="article-card">
      <div class="article-header">
        <div class="article-emoji">📝</div>
        <h1>S3オブジェクトの整合性チェックをどのように行うのか</h1>
        
        <div class="article-meta">
          <time class="article-date" datetime='2022-01-11'>
            2022/01/11 に公開
          </time>
          
          
          
          <span class="reading-time">📖 約1分</span>
        </div>
        <div class="article-tags">
          
          <a href="https://zatoima.github.io/blog/aws/" class="tag-badge">AWS</a>
          
          <a href="https://zatoima.github.io/blog/s3/" class="tag-badge">S3</a>
          
        </div>
        
      </div>
      <div class="article-content">
        <p>下記の記事でも書いた通り、S3へマルチアップロードを行った際はMD5とEtagに差異が発生する。</p>
<blockquote>
<p>S3オブジェクトのmd5やEtagの関係性について整理する | my opinion is my own <a href="https://zatoima.github.io/aws-s3-object-md5-etag/">https://zatoima.github.io/aws-s3-object-md5-etag/</a></p>
</blockquote>
<h3 id="アップロード時">アップロード時</h3>
<p>下記記載の通り、AWS CLIで実行される。標準アップロードとマルチパートアップロードの両方でチェックサム検証を行うと記載ある</p>
<blockquote>
<p><a href="https://docs.aws.amazon.com/cli/latest/topic/s3-faq.html">https://docs.aws.amazon.com/cli/latest/topic/s3-faq.html</a></p>
<h3 id="q-does-the-aws-cli-validate-checksums">Q: Does the AWS CLI validate checksums?</h3>
<p>The AWS CLI will perform checksum validation for uploading and downloading files in specific scenarios.</p>
<h4 id="upload">Upload</h4>
<p>The AWS CLI will calculate and auto-populate the <code>Content-MD5</code> header for both standard and multipart uploads. If the checksum that S3 calculates does not match the <code>Content-MD5</code> provided, S3 will not store the object and instead will return an error message back the AWS CLI. The AWS CLI will retry this error up to 5 times before giving up. On the case that any files fail to transfer successfully to S3, the AWS CLI will exit with a non zero RC. See <code>aws help return-codes</code> for more information.</p>
<h3 id="q-aws-cli-はチェックサムの検証を行いますか">Q: AWS CLI はチェックサムの検証を行いますか？</h3>
<p>AWS CLIは、特定のシナリオでファイルのアップロードとダウンロードのチェックサム検証を実行します。</p>
<h4 id="アップロード">アップロード</h4>
<p>AWS CLI は、標準アップロードとマルチパートアップロードの両方で <code>Content-MD5</code> ヘッダを計算し、自動入力することができます。S3が計算したチェックサムが提供された<code>Content-MD5</code>と一致しない場合、S3はオブジェクトを保存せず、代わりにAWS CLIにエラーメッセージを返します。AWS CLIはこのエラーを5回までリトライして、あきらめる。S3へのファイル転送に失敗した場合、AWS CLIは0以外のRCで終了します。詳細は<code>aws help return-codes</code>を参照してください。</p>
</blockquote>
<h3 id="ダウンロード時">ダウンロード時</h3>
<p>下記の通り、特定条件で整合性チェックが出来ない旨、記載があるので注意が必要。</p>
<ul>
<li>オブジェクトがマルチパートアップロードでアップロードされた場合</li>
<li>オブジェクトがKMSによるサーバーサイドの暗号化を使用してアップロードされた場合</li>
<li>顧客が提供した暗号化キーを使用してオブジェクトをアップロードした場合</li>
</ul>
<blockquote>
<h4 id="download">Download</h4>
<p>The AWS CLI will attempt to verify the checksum of downloads when possible, based on the <code>ETag</code> header returned from a <code>GetObject</code> request that&rsquo;s performed whenever the AWS CLI downloads objects from S3. If the calculated MD5 checksum does not match the expected checksum, the file is deleted and the download is retried. This process is retried up to 3 times. If a downloads fails, the AWS CLI will exit with a non zero RC. See <code>aws help return-codes</code> for more information.</p>
<p>There are several conditions where the CLI is <em>not</em> able to verify checksums on downloads:</p>
<ul>
<li>If the object was uploaded via multipart uploads</li>
<li>If the object was uploaded using server side encryption with KMS</li>
<li>If the object was uploaded using a customer provided encryption key</li>
<li>If the object is downloaded using range <code>GetObject</code> requests</li>
</ul>
<p>ダウンロード
AWS CLIがS3からオブジェクトをダウンロードするたびに実行されるGetObjectリクエストから返されるETagヘッダーに基づいて、可能な場合はダウンロードのチェックサムを確認しようとします。計算されたMD5チェックサムが期待されるチェックサムと一致しない場合、ファイルは削除され、ダウンロードが再試行される。この処理は最大3回まで再試行される。ダウンロードに失敗した場合、AWS CLI は 0 以外の RC で終了する。詳細については、aws help return-codesを参照。</p>
<p>CLIがダウンロードのチェックサムを検証できない条件がいくつかある。</p>
<p>オブジェクトがマルチパートアップロードでアップロードされた場合
オブジェクトがKMSによるサーバーサイドの暗号化を使用してアップロードされた場合
顧客が提供した暗号化キーを使用してオブジェクトをアップロードした場合
オブジェクトが範囲 GetObject リクエストを使用してダウンロードされた場合</p>
</blockquote>
<p>では、特定条件（マルチアップロード時やKMS暗号化している場合等）で整合性チェックが出来ない際にどうすれば良いのかというと、「ファイルをアップロードする前に、 ファイルの MD5 チェックサム値をアップロード後の整合性チェックの参照として使用することができます。」と書いてある通り、metadataを付与してダウンロード後にmd5値を確認するということになる。（実質的に整合性チェックツール等を作ることになる模様）</p>
<blockquote>
<p><a href="https://aws.amazon.com/jp/premiumsupport/knowledge-center/s3-multipart-upload-cli/">Amazon S3 へのマルチパートアップロードに AWS CLI を使用する</a></p>
<p>ファイルをアップロードする前に、 ファイルの MD5 チェックサム値をアップロード後の整合性チェックの参照として使用することができます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>aws s3 cp large_test_file s3://DOC-EXAMPLE-BUCKET/ --metadata md5=&#34;examplemd5value1234/4Q&#34;
</span></span></code></pre></div></blockquote>

      </div>
    </div>

    
    
    <nav class="prev-next-nav">
      
      <a href="https://zatoima.github.io/aws-s3-object-md5-etag/" class="prev-next-link prev-link">
        <span class="prev-next-label">← 前の記事</span>
        <span class="prev-next-title">S3オブジェクトのmd5やEtagの関係性について整理する</span>
      </a>
      
      
      <a href="https://zatoima.github.io/fireware-orion-mongodb-connection-change/" class="prev-next-link next-link">
        <span class="prev-next-label">次の記事 →</span>
        <span class="prev-next-title">Fiware/Orionで使うMongoDBへの接続先を変更する</span>
      </a>
      
    </nav>
    

    
<div class="share-buttons">
  <span class="share-label">共有:</span>
  <a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fzatoima.github.io%2faws-s3-object-checksum-how-to%2f&text=S3%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E6%95%B4%E5%90%88%E6%80%A7%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%82%92%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E8%A1%8C%E3%81%86%E3%81%AE%E3%81%8B" target="_blank" rel="noopener noreferrer" class="share-btn share-twitter" aria-label="Xで共有">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
  </a>
  <a href="https://b.hatena.ne.jp/entry/https://zatoima.github.io/aws-s3-object-checksum-how-to/" target="_blank" rel="noopener noreferrer" class="share-btn share-hatena" aria-label="はてなブックマークに追加">B!</a>
</div>



<div class="related-articles">
  <h2 class="related-articles-title">関連しているかもしれない記事</h2>
  <ul class="related-list">
    
    <li><a href="/aws-s3-object-md5-etag/">S3オブジェクトのmd5やEtagの関係性について整理する</a></li>
    
    <li><a href="/aws-ecr-container-push-pull/">ECRへのコンテナイメージのPush、Pullのメモ</a></li>
    
    <li><a href="/aws-mongodb-install/">Amazon LinuxにMongoDB(5.x系)をインストールする</a></li>
    
    <li><a href="/aws-tokyo-to-osaka-network-outbound-cost/">AWSで東京リージョンから大阪リージョンへのリージョン間のアウトバウンド通信コストを確認</a></li>
    
    <li><a href="/aws-aurora-io-cost-exploler-check/">AuroraのIO料金をCost Explolerから確認する</a></li>
    
  </ul>
</div>




<div class="post-tags">
  
  <a href="https://zatoima.github.io/blog/aws/" class="tag-badge">#AWS</a>
  
  <a href="https://zatoima.github.io/blog/s3/" class="tag-badge">#S3</a>
  
</div>


  </article>

  
  <aside class="article-sidebar">
    <div class="toc-container">
      <div class="toc-title">目次</div>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#アップロード時">アップロード時</a></li>
        <li><a href="#q-does-the-aws-cli-validate-checksums">Q: Does the AWS CLI validate checksums?</a>
          <ul>
            <li><a href="#upload">Upload</a></li>
          </ul>
        </li>
        <li><a href="#q-aws-cli-はチェックサムの検証を行いますか">Q: AWS CLI はチェックサムの検証を行いますか？</a>
          <ul>
            <li><a href="#アップロード">アップロード</a></li>
          </ul>
        </li>
        <li><a href="#ダウンロード時">ダウンロード時</a>
          <ul>
            <li><a href="#download">Download</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </aside>
  
</div>

    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-links">
          <a href="/">ホーム</a>
          <a href="/blog/">記事一覧</a>
          <a href="/tags/">タグ一覧</a>
          <a href="/about/">About</a>
        </div>
        <div class="footer-copyright">Copyright © 2019, zatoima.</div>
      </div>
    </footer>
  </div>
  <script src="/js/lightbox.js" defer></script>
  <script src="/js/toc-highlight.js" defer></script>
  <script src="/js/code-copy.js" defer></script>
  <script src="/js/dark-mode.js" defer></script>
  <script src="/js/mobile-nav.js" defer></script>
  <script src="/js/search.js" defer></script>
</body>

</html>
